# playbook install node_exporter
# ansible-playbook  install.yaml  -e "host_group=suzhou" -e "file_path=/root/node_exporter-1.8.2.linux-amd64.tar.gz" --limit x.x.x.x

- # hosts 通过指定变量传入
  hosts: "{{ host_group }}"
  vars:
    exec_user: "prometheus"
    binary_path: "/usr/local/sbin"
    node_exporter_port: 9100

  tasks:
    - name: create user
      user:
        name: "{{ exec_user }}"
        state: present
        shell: /sbin/nologin
    - name: copy node_exporter tar.gz
      copy:
        src: "{{ file_path }}"
        dest: /tmp/node_exporter.tar.gz

    - name: 解压 node_exporter tar.gz
      unarchive:
        src: /tmp/node_exporter.tar.gz
        dest: /tmp/
        remote_src: yes
        extra_opts: [--overwrite]

    - name: 删除源文件
      file:
        path: /tmp/node_exporter.tar.gz
        state: absent

    - name: 查找解压后的 node_exporter 文件
      find:
        paths: /tmp/
        patterns: "node_exporter*"
        file_type: directory
      register: found_files

    - name: 将 node_exporter 移动到 /usr/local/sbin
      command: mv {{ item.path }}/node_exporter /usr/local/sbin/
      with_items: "{{ found_files.files }}"
      when: found_files.matched > 0

    - name: 确保 node_exporter 在 /usr/local/sbin 下
      stat:
        path: /usr/local/sbin/node_exporter
      register: node_exporter_stat

    - name: 打印 node_exporter 的状态
      debug:
        msg: "node_exporter 已成功移动到 /usr/local/sbin"
      when: node_exporter_stat.stat.exists

    - name: 获取网卡 eno2 的 IP 地址
      setup:
        gather_subset:
          - network

    - set_fact:
      eno2_ip_address: "{{ ansible_facts.eno2.ipv4.address }}"

    - name: 配置 systemd 启动文件
      copy:
        dest: /etc/systemd/system/node-exporter-new.service
        content: |
          [Unit]
          Description=Node Exporter
          Documentation=https://github.com/prometheus/node_exporter
          Wants=network-online.target
          After=network-online.target

          [Service]
          LimitNOFILE=65536
          User={{ exec_user }}
          Group={{ exec_user }}
          Type=simple
          ExecStart={{ binary_path }}/node_exporter \
              --collector.mountstats \
              --collector.sysctl \
              --collector.systemd \
              --collector.tcpstat \
              --web.listen-address={{ eno2_ip_address }}:{{ node_exporter_port }}

          ExecReload=/bin/kill -HUP $MAINPID
          TimeoutStopSec=10s
          Restart=always

          [Install]
          WantedBy=multi-user.target
    - name: 重新加载 systemd 管理器配置
      command: systemctl daemon-reload

    - name: 启动 node-exporter
      systemd:
        name: node-exporter-new
        state: restarted
        enabled: yes
